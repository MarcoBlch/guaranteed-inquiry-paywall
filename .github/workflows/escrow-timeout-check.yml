name: Check Escrow Timeouts

on:
  schedule:
    - cron: '*/10 * * * *' # Toutes les 10 minutes (plus prÃ©cis)
  workflow_dispatch: # Allow manual trigger

jobs:
  check-timeouts:
    runs-on: ubuntu-latest
    steps:
      - name: Send Deadline Reminders
        run: |
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/send-deadline-reminders" \
            -d '{}')
          
          http_code="${response: -3}"
          body="${response%???}"
          
          if [ "$http_code" -ne 200 ]; then
            echo "Warning: Reminder check failed (HTTP $http_code): $body"
          else
            echo "Reminders: $body"
          fi
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Check Expired Escrows
        run: |
          response=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" \
            -H "Content-Type: application/json" \
            "${{ secrets.SUPABASE_URL }}/functions/v1/check-escrow-timeouts" \
            -d '{}')
          
          http_code="${response: -3}"
          body="${response%???}"
          
          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            echo "$body"
            exit 1
          fi
          
          echo "Success: $body"
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: Notify on Failure
        if: failure()
        run: |
          echo "ðŸš¨ Escrow timeout check failed!"

          # Send Discord webhook notification if configured
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
              -H "Content-Type: application/json" \
              -d "{
                \"embeds\": [{
                  \"title\": \"ðŸš¨ Escrow Timeout Check Failed\",
                  \"description\": \"Critical: The escrow timeout check job failed. This could delay refunds to senders!\",
                  \"color\": 15158332,
                  \"fields\": [
                    {\"name\": \"Workflow\", \"value\": \"${{ github.workflow }}\", \"inline\": true},
                    {\"name\": \"Run ID\", \"value\": \"${{ github.run_id }}\", \"inline\": true},
                    {\"name\": \"Frequency\", \"value\": \"Every 10 minutes\", \"inline\": true},
                    {\"name\": \"Action\", \"value\": \"[View Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\"}
                  ],
                  \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                }]
              }"
          fi